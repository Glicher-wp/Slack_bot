# Simple slack bot

Простой бот для слак чата. Подписывается на сообщение и реагирует на "приветЭ. Отправляет сообщения, может реагировать на них.

## Установка бота
Скачайте репозиторий и установите необходимые пакеты
`pip install -r requirements.txt`. Для подписки на ивенты чата потребуется сервер, в который сможет постучаться Slack. Для отладки удобно будет использовать [ngrok](https://ngrok.com/).

## Настройка бота в Slack
Для начала регистрируемся в Slack и создаем рабочее пространоство.
Далее создадим приложение в SlackAPI. Для этого идем по [этому адресу](https://api.slack.com/apps). Нажимаем на кнопку __Create an App__. 

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/h7VWJOX.png)

Далее называем бота и выбираем рабочее пространство. После создания вашего приложения вам будет представлена следующая информационная панель приложения по умолчанию. На этой информационной панели вы будете управлять приложением, устанавливая разрешения, подписываясь на события, устанавливая приложение в рабочие пространства и т. д.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/ZjFaS1i.png)

Чтобы ваше приложение могло отправлять сообщения на канал, вы должны предоставить ему разрешения на отправку сообщений. Для этого нажмите кнопку __Permissions__ (Разрешения) на панели управления.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/IVcN8qg.png)

Прокрутите вниз страницу __OAuth & Permissions__ (OAuth и разрешения), пока не найдете раздел Scopes (Области действия). Найдите подраздел __Bot Token Scopes__ (Области действия токена бота) в области действия и нажмите кнопку __Add an OAuth Scope__ (Добавить область действия OAuth).

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/wQnTSQr.png)

Нажмите кнопку и введите `chat:write`. Выберите это разрешение, чтобы добавить его для вашего бота. Это позволит приложению отправлять сообщения на каналы, к которым у него есть доступ. Для получения доступа к реакциям также добавьте `reactions:write`.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/unQYPeL.png)

Добавив необходимое разрешение и теперь можем установить приложение в рабочее пространство Slack. Прокрутите страницу __OAuth & Permissions__ (OAuth и разрешения) вверх и нажмите кнопку __Install App to Workspace__ (Установить приложение в рабочее пространство) сверху.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/SiSxQB1.png)

Нажмите эту кнопку и посмотрите, какие действия приложение может выполнять на канале. После этого нажмите кнопку __Allow__ (Разрешить) для завершения установки.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/lWUBsYR.png)

После установки бота вы получите для вашего приложения токен доступа __Bot User OAuth Access Token__, который оно сможет использовать для выполнения действий в рабочем пространстве. Этот токен необходимо будет добавить в переменную окружения как __SLACK_TOKEN__.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/m1M9Ilt.png)

В заключение добавьте новый бот в канал внутри вашего рабочего пространства. Если вы еще не создали канала, используйте канал `#general`, который создается по умолчанию в вашем рабочем пространстве Slack. Найдите приложение в разделе __Apps__ (Приложения) на панели навигации клиента Slack и нажмите на него. Затем откройте меню __Details__ (Сведения) в правом верхнем углу. Если ваш клиент Slack открыт не в полноэкранном режиме, значок этого меню будет выглядеть как буква `i` внутри окружности.

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/OJ5yTXP.png)

Чтобы завершить добавление приложения на канал, нажмите кнопку __More__ (Дополнительно) со значком трех точек на странице сведений и выберите __Add this app to a channel…__ (Добавить это приложение в канал…). Введите название канала в открытое модальное окно и нажмите __Add__ (Добавить).

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/ojUMqeI.png)

Теперь нужно добавить приложение как авторизованный обработчик.
Перейдите в раздел __Basic Information__ (Базовая информация) вашего приложения в [пользовательском интерфейсе Slack](https://api.slack.com/apps). Прокручивайте экран вниз, пока не найдете раздел __App Credentials__ (Полномочия приложения).

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/lLB1jEB.png)

Скопируйте __секретную подпись__ (Signing Secret) и экспортируйте ее в переменную среды `SLACK_EVENTS_TOKEN`. Это все токены необходимые для работы в приложении.

Предоставьте своему приложению необходимые разрешения для мониторинга сообщений и реагирования на них. Откройте раздел __Event Subscriptions__ (Подписка на события) в боковой панели пользовательского интерфейса и нажмите кнопку __Enable Events__ (Активировать события).

После этого введите свой IP-адрес, порт и конечную точку `/api/msg` в поле __Request URL__ (URL-адрес запроса). Не забудьте указать префикс протокола HTTPS. Slack попытается выполнить подключение к указанной конечной точке. После успешного подключения вы увидите зеленую отметку со словом __Verified__ (Проверено).

![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/9wqUJwd.png)

Затем откройте раздел __Subscribe to bot events__ (Подписка на события ботов) и добавьте для вашего приложения разрешение `message.channels`. Это позволит вашему приложению получать сообщения от канала и обрабатывать их.


![куда-то делась картинка](https://assets.digitalocean.com/articles/coinbot/sCYYhM8.png)

После этого останется сохранить изменения и переустановить приложение в Slack.
